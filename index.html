<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Todo List</title>

    <!-- Bootstrap v5.3 -->
    <link
      rel="stylesheet"
      href="assets/vendor/bootstrap-5.3.7/package/dist/css/bootstrap.min.css"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="assets/vendor/bootstrap-icons-1.13.1/package/font/bootstrap-icons.min.css"
    />
    <!-- Google Fonts -->
    <link 
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" 
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/style/custom.css">


    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  </head>
  <body>
    <div class="container mt-5">
      <div>
        <ul class="nav nav-tabs mb-3">
          <!-- <li class="nav-item">
            <a class="nav-link" href="magic-number.html">Magic Number</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/password-checker.html">Password Checker</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Todo List</a>
          </li> -->
        </ul>

        <h1>Todo List</h1>

        <hr />
        
        <!-- Form -->
        <form id="formData">
          <div class="mb-3">
            <label for="text" class="form-label">
              Apa rencana kamu selanjutnya?
            </label>
            <div class="input-group flex-nowrap">
              <input type="text" class="form-control" name="todo" id="todoInput" />
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="bi bi-plus"></i> Tambah
              </button>
              <button type="button" class="btn btn-secondary d-none" id="cancelEditBtn">
                <i class="bi bi-x"></i> Batal
              </button>
            </div>
            <div class="form-text text-danger d-none" id="duplicateWarning">
              Todo dengan judul yang sama sudah ada!
            </div>
          </div>
        </form>

        <!-- Filter dan Search -->
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="btn-group" role="group" aria-label="Filter todos">
              <input type="radio" class="btn-check" name="filter" id="filterAll" value="all" checked>
              <label class="btn btn-outline-primary" for="filterAll">Semua</label>

              <input type="radio" class="btn-check" name="filter" id="filterPending" value="pending">
              <label class="btn btn-outline-warning" for="filterPending">Belum Selesai</label>

              <input type="radio" class="btn-check" name="filter" id="filterCompleted" value="completed">
              <label class="btn btn-outline-success" for="filterCompleted">Selesai</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" id="searchInput" placeholder="Cari todo...">
              <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Todo Statistics -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="alert alert-info">
              <small>
                Total: <span id="totalCount">0</span> | 
                Selesai: <span id="completedCount">0</span> | 
                Belum Selesai: <span id="pendingCount">0</span> |
                Ditampilkan: <span id="displayedCount">0</span>
              </small>
            </div>
          </div>
        </div>

        <ul class="list-group" id="todoList">
          <!-- Todos will be rendered here -->
        </ul>

        <!-- Empty State -->
        <div class="text-center mt-4 d-none" id="emptyState">
          <i class="bi bi-clipboard-x fs-1 text-muted"></i>
          <p class="text-muted">Tidak ada todo yang ditemukan</p>
        </div>
      </div>
    </div>

    <script>
      let todos = [];
      let currentFilter = 'all';
      let currentSearch = '';
      let editingIndex = -1;

      // Initialize Sortable
      let sortable;

      function initSortable() {
        const todoList = document.getElementById("todoList");
        if (sortable) {
          sortable.destroy();
        }
        
        sortable = new Sortable(todoList, {
          animation: 150,
          ghostClass: 'sortable-ghost',
          chosenClass: 'sortable-chosen',
          onEnd: function(evt) {
            // Get the filtered todos that are currently displayed
            const filteredTodos = getFilteredTodos();
            
            // Reorder the original todos array based on the new order
            const movedItem = filteredTodos[evt.oldIndex];
            
            // Find the original index of the moved item
            const originalOldIndex = todos.findIndex(todo => todo.id === movedItem.id);
            
            // Remove from original position
            const [removed] = todos.splice(originalOldIndex, 1);
            
            // Calculate new position in original array
            let newIndex;
            if (evt.newIndex === 0) {
              // Moving to top
              if (filteredTodos.length > 1) {
                const nextItem = filteredTodos[1];
                newIndex = todos.findIndex(todo => todo.id === nextItem.id);
              } else {
                newIndex = 0;
              }
            } else if (evt.newIndex === filteredTodos.length - 1) {
              // Moving to bottom
              const prevItem = filteredTodos[evt.newIndex - 1];
              const prevOriginalIndex = todos.findIndex(todo => todo.id === prevItem.id);
              newIndex = prevOriginalIndex + 1;
            } else {
              // Moving to middle
              const nextItem = filteredTodos[evt.newIndex + 1];
              newIndex = todos.findIndex(todo => todo.id === nextItem.id);
            }
            
            // Insert at new position
            todos.splice(newIndex, 0, removed);
            
            // Save and re-render
            saveTodos();
            renderTodos();
          }
        });
      }

      function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      function saveTodos() {
        localStorage.setItem("todos", JSON.stringify(todos));
      }

      function loadTodos() {
        const storedTodos = localStorage.getItem("todos");
        if (storedTodos) {
          todos = JSON.parse(storedTodos);
          // Add IDs to existing todos if they don't have them
          todos.forEach(todo => {
            if (!todo.id) {
              todo.id = generateId();
            }
          });
        }
      }

      function isDuplicateTodo(todoText, excludeIndex = -1) {
        return todos.some((todo, index) => 
          todo.todo.toLowerCase().trim() === todoText.toLowerCase().trim() && 
          index !== excludeIndex
        );
      }

      function getFilteredTodos() {
        let filtered = todos;

        // Apply search filter
        if (currentSearch.trim() !== '') {
          filtered = filtered.filter(todo =>
            todo.todo.toLowerCase().includes(currentSearch.toLowerCase())
          );
        }

        // Apply status filter
        switch (currentFilter) {
          case 'completed':
            filtered = filtered.filter(todo => todo.completed);
            break;
          case 'pending':
            filtered = filtered.filter(todo => !todo.completed);
            break;
          default:
            // 'all' - no additional filtering needed
            break;
        }

        return filtered;
      }

      function updateStatistics() {
        const totalCount = todos.length;
        const completedCount = todos.filter(todo => todo.completed).length;
        const pendingCount = totalCount - completedCount;
        const displayedCount = getFilteredTodos().length;

        document.getElementById('totalCount').textContent = totalCount;
        document.getElementById('completedCount').textContent = completedCount;
        document.getElementById('pendingCount').textContent = pendingCount;
        document.getElementById('displayedCount').textContent = displayedCount;
      }

      function renderTodos() {
        const todoList = document.getElementById("todoList");
        const emptyState = document.getElementById("emptyState");
        const filteredTodos = getFilteredTodos();

        todoList.innerHTML = "";

        if (filteredTodos.length === 0) {
          emptyState.classList.remove('d-none');
          if (sortable) {
            sortable.destroy();
            sortable = null;
          }
        } else {
          emptyState.classList.add('d-none');
          
          filteredTodos.forEach((item, displayIndex) => {
            const originalIndex = todos.findIndex(todo => todo.id === item.id);
            const li = document.createElement("li");
            li.className = "list-group-item d-flex todo-item";
            li.dataset.id = item.id;

            if (editingIndex === originalIndex) {
              li.classList.add('edit-mode');
            }

            const div = document.createElement("div");
            div.className = "flex-fill d-flex align-items-center";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.className = "form-check-input me-2";
            checkbox.checked = item.completed;
            checkbox.addEventListener("change", () => {
              item.completed = checkbox.checked;
              saveTodos();
              renderTodos();
              updateStatistics();
            });

            const label = document.createElement("label");
            label.className = "form-check-label flex-fill";
            label.style.cursor = "pointer";

            if (item.completed) {
              label.style.textDecoration = "line-through";
              label.style.color = "#6c757d";
            } else {
              label.style.textDecoration = "none";
              label.style.color = "inherit";
            }
            label.textContent = item.todo;

            label.addEventListener("click", () => checkbox.click());

            div.appendChild(checkbox);
            div.appendChild(label);

            // Buttons container
            const buttonContainer = document.createElement("div");
            buttonContainer.className = "d-flex gap-1";

            // Edit button
            const editButton = document.createElement("button");
            editButton.className = "btn btn-sm btn-outline-secondary";
            editButton.innerHTML = '<i class="bi bi-pencil"></i>';
            editButton.title = "Edit todo";
            editButton.addEventListener("click", () => editTodo(originalIndex));

            // Delete button
            const deleteButton = document.createElement("button");
            deleteButton.className = "btn btn-sm btn-outline-danger";
            deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
            deleteButton.title = "Hapus todo";
            deleteButton.addEventListener("click", () => deleteTodo(originalIndex));

            buttonContainer.appendChild(editButton);
            buttonContainer.appendChild(deleteButton);

            li.appendChild(div);
            li.appendChild(buttonContainer);
            todoList.appendChild(li);
          });

          // Initialize sortable after rendering
          setTimeout(() => initSortable(), 0);
        }

        updateStatistics();
      }

      function addTodo(todoText) {
        if (isDuplicateTodo(todoText)) {
          showDuplicateWarning();
          return false;
        }

        hideDuplicateWarning();
        todos.unshift({
          id: generateId(),
          todo: todoText,
          completed: false,
        });

        saveTodos();
        renderTodos();
        return true;
      }

      function editTodo(index) {
        editingIndex = index;
        const todo = todos[index];
        const todoInput = document.getElementById('todoInput');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelEditBtn');

        todoInput.value = todo.todo;
        submitBtn.innerHTML = '<i class="bi bi-check"></i> Update';
        submitBtn.className = 'btn btn-warning';
        cancelBtn.classList.remove('d-none');

        renderTodos();
        todoInput.focus();
      }

      function cancelEdit() {
        editingIndex = -1;
        const todoInput = document.getElementById('todoInput');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelEditBtn');

        todoInput.value = '';
        submitBtn.innerHTML = '<i class="bi bi-plus"></i> Tambah';
        submitBtn.className = 'btn btn-primary';
        cancelBtn.classList.add('d-none');
        hideDuplicateWarning();

        renderTodos();
      }

      function updateTodo(index, newText) {
        if (isDuplicateTodo(newText, index)) {
          showDuplicateWarning();
          return false;
        }

        hideDuplicateWarning();
        todos[index].todo = newText;
        saveTodos();
        cancelEdit();
        return true;
      }

      function deleteTodo(index) {
        if (confirm('Apakah Anda yakin ingin menghapus todo ini?')) {
          todos.splice(index, 1);
          saveTodos();
          renderTodos();

          // Cancel edit mode if we're deleting the item being edited
          if (editingIndex === index) {
            cancelEdit();
          } else if (editingIndex > index) {
            editingIndex--; // Adjust edit index if needed
          }
        }
      }

      function showDuplicateWarning() {
        document.getElementById('duplicateWarning').classList.remove('d-none');
      }

      function hideDuplicateWarning() {
        document.getElementById('duplicateWarning').classList.add('d-none');
      }

      function applyFilters() {
        renderTodos();
      }

      // Event Listeners
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("formData");
        const searchInput = document.getElementById("searchInput");
        const clearSearchBtn = document.getElementById("clearSearch");
        const cancelEditBtn = document.getElementById("cancelEditBtn");
        const filterRadios = document.querySelectorAll('input[name="filter"]');

        // Load todos from localStorage
        loadTodos();

        // Form submission
        form.addEventListener("submit", function (event) {
          event.preventDefault();
          const todoInput = form.todo.value.trim();

          if (todoInput === "") {
            alert("Todo tidak boleh kosong!");
            return;
          }

          let success;
          if (editingIndex >= 0) {
            success = updateTodo(editingIndex, todoInput);
          } else {
            success = addTodo(todoInput);
          }

          if (success) {
            form.todo.value = "";
          }
        });

        // Cancel edit
        cancelEditBtn.addEventListener('click', cancelEdit);

        // Search functionality
        searchInput.addEventListener('input', function() {
          currentSearch = this.value;
          applyFilters();
        });

        // Clear search
        clearSearchBtn.addEventListener('click', function() {
          searchInput.value = '';
          currentSearch = '';
          applyFilters();
        });

        // Filter functionality
        filterRadios.forEach(radio => {
          radio.addEventListener('change', function() {
            if (this.checked) {
              currentFilter = this.value;
              applyFilters();
            }
          });
        });

        // Initial render
        renderTodos();
      });

      // Save todos before page unload
      window.addEventListener("beforeunload", saveTodos);
    </script>
  </body>
</html>