<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Todo List</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- Bootstrap v5.3.7 Local -->
    <link
      rel="stylesheet"
      href="/assets/vendor/bootstrap-5.3.7/package/dist/css/bootstrap.min.css"
    />
    <!-- Bootstrap Icons Local -->
    <link
      rel="stylesheet"
      href="/assets/vendor/bootstrap-icons-1.13.1/package/font/bootstrap-icons.min.css"
    />
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  </head>
  <body class="bg-body-secondary">
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <h1 class="text-center mb-4">Enhanced Todo List</h1>

          <!-- Semua fitur dalam 1 Card -->
          <div class="card shadow-sm">
            <div class="card-body">

              <!-- Form untuk menambah todo -->
              <form id="todoForm" class="mb-4">
                <div class="mb-3">
                  <label for="todoInput" class="form-label">
                    Apa rencana kamu selanjutnya?
                  </label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      id="todoInput"
                      name="todo"
                      placeholder="Masukkan todo baru..."
                      required
                    />
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                      <i class="bi bi-plus"></i> <span id="submitText">Tambah</span>
                    </button>
                  </div>
                  <div class="form-text text-danger" id="errorMessage" style="display: none;"></div>
                </div>
              </form>

              <!-- Filter dan Pencarian -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <label for="filterSelect" class="form-label">Filter</label>
                  <select class="form-select" id="filterSelect">
                    <option value="all">Semua Todo</option>
                    <option value="active">Belum Selesai</option>
                    <option value="completed">Sudah Selesai</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="searchInput" class="form-label">Pencarian</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      id="searchInput"
                      placeholder="Cari todo..."
                    />
                    <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Daftar Todo -->
              <h5 class="mb-3">
                <i class="bi bi-list-task"></i> Daftar Todo
                <small class="text-muted">(Drag & drop untuk mengurutkan)</small>
              </h5>
              <ul class="list-unstyled bg-light p-3 rounded shadow-sm" id="todoList">
                <li class="text-center text-muted" id="emptyState">
                  <i class="bi bi-clipboard-x fs-1"></i>
                  <p class="mb-0">Belum ada todo. Tambahkan yang pertama!</p>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Konfirmasi Hapus</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            Apakah Anda yakin ingin menghapus todo ini?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-danger" id="confirmDelete">Hapus</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Local -->
    <script src="/assets/vendor/bootstrap-5.3.7/package/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script TodoApp -->
    <script>
      class TodoApp {
        constructor() {
          this.todos = [];
          this.currentFilter = "all";
          this.currentSearch = "";
          this.editingId = null;
          this.deleteModal = new bootstrap.Modal(document.getElementById("deleteModal"));
          this.todoToDelete = null;
          this.init();
        }

        init() {
          this.loadTodos();
          this.bindEvents();
          this.initSortable();
          this.render();
        }

        loadTodos() {
          const stored = JSON.parse(localStorage.getItem("enhancedTodos") || "[]");
          this.todos = stored.map((todo, index) => ({
            ...todo,
            id: todo.id || Date.now() + index,
          }));
        }

        saveTodos() {
          localStorage.setItem("enhancedTodos", JSON.stringify(this.todos));
        }

        bindEvents() {
          document.getElementById("todoForm").addEventListener("submit", (e) => {
            e.preventDefault();
            this.handleSubmit();
          });
          document.getElementById("filterSelect").addEventListener("change", (e) => {
            this.currentFilter = e.target.value;
            this.render();
          });
          document.getElementById("searchInput").addEventListener("input", (e) => {
            this.currentSearch = e.target.value;
            this.render();
          });
          document.getElementById("clearSearch").addEventListener("click", () => {
            document.getElementById("searchInput").value = "";
            this.currentSearch = "";
            this.render();
          });
          document.getElementById("confirmDelete").addEventListener("click", () => {
            if (this.todoToDelete !== null) {
              this.deleteTodo(this.todoToDelete);
              this.deleteModal.hide();
              this.todoToDelete = null;
            }
          });
        }

        initSortable() {
          const todoList = document.getElementById("todoList");
          this.sortable = Sortable.create(todoList, {
            animation: 150,
            ghostClass: "opacity-50",
            chosenClass: "bg-body-tertiary",
            filter: ".btn, input[type='checkbox'], label",
            onEnd: (evt) => {
              if (evt.oldIndex !== evt.newIndex) {
                this.reorderTodos(evt.oldIndex, evt.newIndex);
              }
            },
          });
        }

        handleSubmit() {
          const input = document.getElementById("todoInput");
          const text = input.value.trim();
          const errorDiv = document.getElementById("errorMessage");
          if (!text) {
            this.showError("Todo tidak boleh kosong!");
            return;
          }
          if (this.editingId) {
            this.updateTodo(this.editingId, text);
          } else {
            if (this.isDuplicate(text)) {
              this.showError("Todo dengan judul yang sama sudah ada!");
              return;
            }
            this.addTodo(text);
          }
          input.value = "";
          errorDiv.style.display = "none";
        }

        showError(message) {
          const errorDiv = document.getElementById("errorMessage");
          errorDiv.textContent = message;
          errorDiv.style.display = "block";
          setTimeout(() => {
            errorDiv.style.display = "none";
          }, 3000);
        }

        isDuplicate(text) {
          return this.todos.some(
            (todo) =>
              todo.text.toLowerCase() === text.toLowerCase() &&
              todo.id !== this.editingId
          );
        }

        addTodo(text) {
          const todo = {
            id: Date.now(),
            text: text,
            completed: false,
            createdAt: new Date().toISOString(),
          };
          this.todos.unshift(todo);
          this.saveTodos();
          this.render();
        }

        updateTodo(id, newText) {
          const todo = this.todos.find((t) => t.id === id);
          if (todo) {
            todo.text = newText;
            this.saveTodos();
            this.cancelEdit();
            this.render();
          }
        }

        toggleTodo(id) {
          const todo = this.todos.find((t) => t.id === id);
          if (todo) {
            todo.completed = !todo.completed;
            todo.completedAt = todo.completed ? new Date().toISOString() : null;
            this.saveTodos();
            this.render();
          }
        }

        deleteTodo(id) {
          this.todos = this.todos.filter((t) => t.id !== id);
          this.saveTodos();
          this.render();
        }

        editTodo(id) {
          const todo = this.todos.find((t) => t.id === id);
          if (todo) {
            this.editingId = id;
            document.getElementById("todoInput").value = todo.text;
            document.getElementById("submitText").textContent = "Update";
            document.getElementById("submitBtn").className = "btn btn-info px-4";
            document.querySelector(`[data-id="${id}"]`).classList.add("border-warning");
          }
        }

        cancelEdit() {
          this.editingId = null;
          document.getElementById("todoInput").value = "";
          document.getElementById("submitText").textContent = "Tambah";
          document.getElementById("submitBtn").className = "btn btn-primary px-4";
          document.querySelectorAll(".border-warning").forEach((el) => {
            el.classList.remove("border-warning");
          });
        }

        reorderTodos(oldIndex, newIndex) {
          const filteredTodos = this.getFilteredTodos();
          const [movedTodo] = filteredTodos.splice(oldIndex, 1);
          filteredTodos.splice(newIndex, 0, movedTodo);
          this.todos = filteredTodos;
          this.saveTodos();
          this.render();
        }

        getFilteredTodos() {
          let filtered = [...this.todos];
          switch (this.currentFilter) {
            case "active":
              filtered = filtered.filter((todo) => !todo.completed);
              break;
            case "completed":
              filtered = filtered.filter((todo) => todo.completed);
              break;
          }
          if (this.currentSearch) {
            filtered = filtered.filter((todo) =>
              todo.text.toLowerCase().includes(this.currentSearch.toLowerCase())
            );
          }
          return filtered;
        }

        render() {
          const todoList = document.getElementById("todoList");
          const emptyState = document.getElementById("emptyState");
          const filteredTodos = this.getFilteredTodos();
          todoList.innerHTML = "";
          if (filteredTodos.length === 0) {
            todoList.appendChild(emptyState.cloneNode(true));
            return;
          }
          filteredTodos.forEach((todo) => {
            const li = this.createTodoElement(todo);
            todoList.appendChild(li);
          });
          if (this.sortable) {
            this.sortable.destroy();
          }
          this.initSortable();
        }

        createTodoElement(todo) {
          const li = document.createElement("li");
          li.setAttribute("data-id", todo.id);
          const borderClass = todo.completed
            ? "border-success bg-white"
            : "border-warning bg-white";
          li.innerHTML = `
            <div class="card mb-2 shadow-sm border-start border-5 ${borderClass}">
              <div class="card-body d-flex align-items-center">
                <div class="drag-handle me-3 text-muted">
                  <i class="bi bi-grip-vertical fs-4"></i>
                </div>
                <div class="form-check flex-grow-1">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    ${todo.completed ? "checked" : ""}
                    onchange="todoApp.toggleTodo(${todo.id})"
                  >
                  <label class="form-check-label ${
                    todo.completed
                      ? "text-decoration-line-through text-muted"
                      : "fw-semibold"
                  } fs-5">
                    ${todo.text}
                  </label>
                </div>
                <div class="btn-group">
                  ${
                    !todo.completed
                      ? `<button class="btn btn-warning btn-sm text-white fw-bold" onclick="todoApp.toggleTodo(${todo.id})">Belum Selesai</button>`
                      : `<button class="btn btn-success btn-sm fw-bold" onclick="todoApp.toggleTodo(${todo.id})">Selesai</button>`
                  }
                  <button class="btn btn-info btn-sm text-white" onclick="todoApp.editTodo(${todo.id})"><i class="bi bi-pencil-square"></i></button>
                  <button class="btn btn-danger btn-sm" onclick="todoApp.showDeleteConfirm(${todo.id})"><i class="bi bi-trash3"></i></button>
                </div>
              </div>
            </div>
          `;
          return li;
        }

        showDeleteConfirm(id) {
          this.todoToDelete = id;
          this.deleteModal.show();
        }
      }

      const todoApp = new TodoApp();
      window.addEventListener("beforeunload", () => {
        todoApp.saveTodos();
      });
    </script>
  </body>
</html>
